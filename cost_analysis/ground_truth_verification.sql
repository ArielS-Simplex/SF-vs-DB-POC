-- GROUND TRUTH VERIFICATION QUERIES
-- Run these to validate cost analysis math

-- ========================================
-- 1. VERIFY CREDITS USED (Ground Truth)
-- ========================================

-- Check actual credits consumed in last 24 hours
SELECT 
    'ACTUAL CREDITS VERIFICATION' AS verification_type,
    warehouse_name,
    SUM(credits_used) AS actual_credits_consumed,
    SUM(credits_used_compute) AS compute_credits,
    SUM(credits_used_cloud_services) AS cloud_services_credits,
    COUNT(*) AS billing_periods,
    MIN(start_time) AS period_start,
    MAX(end_time) AS period_end
FROM SNOWFLAKE.ACCOUNT_USAGE.WAREHOUSE_METERING_HISTORY
WHERE start_time >= DATEADD('day', -1, CURRENT_TIMESTAMP())
GROUP BY warehouse_name
ORDER BY actual_credits_consumed DESC;


VERIFICATION_TYPE	WAREHOUSE_NAME	ACTUAL_CREDITS_CONSUMED	COMPUTE_CREDITS	CLOUD_SERVICES_CREDITS	BILLING_PERIODS	PERIOD_START	PERIOD_END
ACTUAL CREDITS VERIFICATION	X_SMALL_2_GEN	10.872844725	10.865625000	0.007219725	5	2025-09-14 00:00:00.000 -0700	2025-09-14 13:00:00.000 -0700
ACTUAL CREDITS VERIFICATION	X_SMALL_1_GEN	3.338027762	3.330833310	0.007194452	10	2025-09-14 00:00:00.000 -0700	2025-09-14 13:00:00.000 -0700
-- ========================================
-- 2. VERIFY RECORD COUNTS (Ground Truth)
-- ========================================

-- Actual records processed in each table
SELECT 'RECORD COUNT VERIFICATION' AS verification_type,
       'NCP_SILVER_V2' AS table_name,
       COUNT(*) AS actual_records,
       MIN(transaction_date) AS date_start,
       MAX(transaction_date) AS date_end
FROM POC.PUBLIC.NCP_SILVER_V2
WHERE DATE(transaction_date) = '2025-09-05'

UNION ALL

SELECT 'RECORD COUNT VERIFICATION',
       'NCP_BRONZE_V2',
       COUNT(*),
       MIN(transaction_date),
       MAX(transaction_date)
FROM POC.PUBLIC.NCP_BRONZE_V2
WHERE DATE(transaction_date) = '2025-09-05';


VERIFICATION_TYPE	TABLE_NAME	ACTUAL_RECORDS	DATE_START	DATE_END
RECORD COUNT VERIFICATION	NCP_SILVER_V2	12686818	2025-09-05 00:00:00.017	2025-09-05 23:59:59.997
RECORD COUNT VERIFICATION	NCP_BRONZE_V2	13162623	2025-09-05 00:00:00.017	2025-09-05 23:59:59.997
-- ========================================
-- 3. VERIFY QUERY EXECUTION TIMES (Ground Truth)
-- ========================================

-- Actual execution times for ETL queries
SELECT 
    'EXECUTION TIME VERIFICATION' AS verification_type,
    query_type,
    COUNT(*) AS query_count,
    SUM(execution_time) / 1000 / 60 AS total_minutes,
    AVG(execution_time) / 1000 AS avg_seconds,
    MAX(execution_time) / 1000 AS max_seconds,
    SUM(credits_used_cloud_services) AS actual_credits
FROM SNOWFLAKE.ACCOUNT_USAGE.QUERY_HISTORY
WHERE start_time >= DATEADD('day', -1, CURRENT_TIMESTAMP())
  AND (
    query_text ILIKE '%ncp_bronze%' OR
    query_text ILIKE '%ncp_silver%' OR
    query_text ILIKE '%staging%'
  )
  AND execution_status = 'SUCCESS'
GROUP BY query_type
ORDER BY total_minutes DESC;



VERIFICATION_TYPE	QUERY_TYPE	QUERY_COUNT	TOTAL_MINUTES	AVG_SECONDS	MAX_SECONDS	ACTUAL_CREDITS
EXECUTION TIME VERIFICATION	CREATE_TABLE_AS_SELECT	7	17.209866666667	147.513142857000	366.425000	0.001119
EXECUTION TIME VERIFICATION	SELECT	124	1.253516666667	0.606540323000	3.382000	0.005833
EXECUTION TIME VERIFICATION	COPY	2	1.232383333333	36.971500000000	56.328000	0.001027
EXECUTION TIME VERIFICATION	SET	41	0.007383333333	0.010804878000	0.021000	0.000275
EXECUTION TIME VERIFICATION	CREATE_TABLE	3	0.004533333333	0.090666667000	0.095000	7.6e-05
EXECUTION TIME VERIFICATION	SHOW	17	0.003683333333	0.013000000000	0.039000	0
EXECUTION TIME VERIFICATION	DROP	2	0.002366666667	0.071000000000	0.141000	3.4e-05
EXECUTION TIME VERIFICATION	DESCRIBE	9	0.000600000000	0.004000000000	0.006000	4.3e-05
-- ========================================
-- 4. VERIFY STORAGE COSTS (Ground Truth)
-- ========================================

-- Actual storage usage and costs
SELECT 
    'STORAGE COST VERIFICATION' AS verification_type,
    table_name,
    active_bytes / POWER(1024, 3) AS active_gb,
    time_travel_bytes / POWER(1024, 3) AS time_travel_gb,
    failsafe_bytes / POWER(1024, 3) AS failsafe_gb,
    (active_bytes + time_travel_bytes + failsafe_bytes) / POWER(1024, 3) AS total_storage_gb
FROM SNOWFLAKE.ACCOUNT_USAGE.TABLE_STORAGE_METRICS
WHERE table_name IN ('NCP_SILVER_V2', 'NCP_BRONZE_V2', 'NCP_BRONZE_STAGING_V2')
  AND table_schema = 'PUBLIC'
ORDER BY total_storage_gb DESC;



VERIFICATION_TYPE	TABLE_NAME	ACTIVE_GB	TIME_TRAVEL_GB	FAILSAFE_GB	TOTAL_STORAGE_GB
STORAGE COST VERIFICATION	NCP_BRONZE_V2	0	0	22.88452816	22.88452816
STORAGE COST VERIFICATION	NCP_BRONZE_V2	18.962323666	0	0	18.962323666
STORAGE COST VERIFICATION	NCP_BRONZE_V2	0	0	18.801882744	18.801882744
STORAGE COST VERIFICATION	NCP_BRONZE_STAGING_V2	0	0	12.114481449	12.114481449
STORAGE COST VERIFICATION	NCP_BRONZE_STAGING_V2	10.3580513	0	0	10.3580513
STORAGE COST VERIFICATION	NCP_BRONZE_STAGING_V2	0	0	10.357342243	10.357342243
STORAGE COST VERIFICATION	NCP_BRONZE_V2	0	0	3.509988785	3.509988785
STORAGE COST VERIFICATION	NCP_BRONZE_V2	0	0	3.507549763	3.507549763
STORAGE COST VERIFICATION	NCP_BRONZE_STAGING_V2	0	0	1.92016077	1.92016077
STORAGE COST VERIFICATION	NCP_SILVER_V2	1.538045406	0	0	1.538045406
STORAGE COST VERIFICATION	NCP_SILVER_V2	1.536943913	0	0	1.536943913
STORAGE COST VERIFICATION	NCP_SILVER_V2	1.534909725	0	0	1.534909725
STORAGE COST VERIFICATION	NCP_SILVER_V2	1.534698963	0	0	1.534698963
STORAGE COST VERIFICATION	NCP_SILVER_V2	1.534613132	0	0	1.534613132
STORAGE COST VERIFICATION	NCP_SILVER_V2	1.53406477	0	0	1.53406477
STORAGE COST VERIFICATION	NCP_SILVER_V2	1.533968925	0	0	1.533968925
STORAGE COST VERIFICATION	NCP_SILVER_V2	1.533598423	0	0	1.533598423
STORAGE COST VERIFICATION	NCP_SILVER_V2	1.529778481	0	0	1.529778481
STORAGE COST VERIFICATION	NCP_SILVER_V2	1.52049017	0	0	1.52049017
STORAGE COST VERIFICATION	NCP_SILVER_V2	1.513400555	0	0	1.513400555
STORAGE COST VERIFICATION	NCP_SILVER_V2	1.512539864	0	0	1.512539864
STORAGE COST VERIFICATION	NCP_SILVER_V2	1.511116028	0	0	1.511116028
STORAGE COST VERIFICATION	NCP_SILVER_V2	1.510117054	0	0	1.510117054
STORAGE COST VERIFICATION	NCP_SILVER_V2	1.494107246	0	0	1.494107246
STORAGE COST VERIFICATION	NCP_SILVER_V2	1.493076801	0	0	1.493076801
STORAGE COST VERIFICATION	NCP_SILVER_V2	1.492856026	0	0	1.492856026
STORAGE COST VERIFICATION	NCP_SILVER_V2	1.491251945	0	0	1.491251945
STORAGE COST VERIFICATION	NCP_SILVER_V2	0	0	0.8253488541	0.8253488541
STORAGE COST VERIFICATION	NCP_SILVER_V2	0.4823212624	0	0	0.4823212624
STORAGE COST VERIFICATION	NCP_SILVER_V2	0	0	0.1512331963	0.1512331963
STORAGE COST VERIFICATION	NCP_SILVER_V2	0	0	0.1512041092	0.1512041092
STORAGE COST VERIFICATION	NCP_SILVER_V2	0	0	0	0
STORAGE COST VERIFICATION	NCP_SILVER_V2	0	0	0	0
STORAGE COST VERIFICATION	NCP_BRONZE_STAGING_V2	0	0	0	0
STORAGE COST VERIFICATION	NCP_BRONZE_V2	0	0	0	0
STORAGE COST VERIFICATION	NCP_BRONZE_STAGING_V2	0	0	0	0
STORAGE COST VERIFICATION	NCP_BRONZE_STAGING_V2	0	0	0	0
STORAGE COST VERIFICATION	NCP_BRONZE_STAGING_V2	0	0	0	0
STORAGE COST VERIFICATION	NCP_BRONZE_V2	0	0	0	0
STORAGE COST VERIFICATION	NCP_SILVER_V2	0	0	0	0
STORAGE COST VERIFICATION	NCP_SILVER_V2	0	0	0	0
-- ========================================
-- 5. VERIFY COPY OPERATION COSTS (Ground Truth)
-- ========================================

-- Actual S3 data loading costs
SELECT 
    'COPY OPERATION VERIFICATION' AS verification_type,
    COUNT(*) AS copy_operations,
    SUM(files_scanned) AS total_files,
    SUM(rows_loaded) AS total_rows_loaded,
    SUM(bytes_loaded) / POWER(1024, 3) AS total_gb_loaded,
    SUM(credits_used_cloud_services) AS copy_credits_used,
    AVG(execution_time) / 1000 AS avg_copy_seconds
FROM SNOWFLAKE.ACCOUNT_USAGE.COPY_HISTORY
WHERE start_time >= DATEADD('day', -1, CURRENT_TIMESTAMP())
  AND table_name = 'NCP_BRONZE_STAGING_V2'
  AND status = 'Loaded';
